


难道是 refine 操作的锅，不然不会浮动的

VT 第二步影响不大，并且都是优化，(体现在人像周围的细腻程度)

第一步会影响 ~~卡通化的程度、对应程度~~ 影响色块（造成七彩色块浮动）

实验不好，原因：
表象：
视频中脸部无法正常扭转过来



这种容易分辨的广告，真不真，假不假是严重不行的。

GAN 模型中，数据集真的很重要

默认的那个模型适用于远景，

最好 style_id 的性别与原始对应

素材中，头上最好不要大的装饰物




> 至少把作者的 dualstyle 丢到 vt 里面训练了，证明后面的步骤没啥问题

> 推导 vt 视频时， style_id 更多体现在整体结构上，如脸长；style_degree 更多体现在脸部细节上

> disney 训练，默认参数还是好，，默认风格更新质量还是好。

这种单个的任务，单独训比混合训好太多了

好的、类似的数据集和默认参数，没啥改动，也会好很多








## 部署

```bash
cd SageMaker/VToonify/
source activate
conda env create -f ./environment/vtoonify_env.yaml
conda activate vtoonify_env

ipython kernel install --user --name vt
```

```bash
pip install gdown
gdown https://drive.google.com/drive/folders/1YvFj33Bfum4YuBeqNNCYLfiBrD4tpzg7 -O ./checkpoint/anime --folder
gdown https://drive.google.com/drive/folders/1JmimgKR_Xo-lR8n35e_V9wEicSUaJqMz -O ./checkpoint/fantasy --folder
gdown https://drive.google.com/drive/folders/1d0Lb-B7ozphXLywRjVLXQI0PTC5PESfn -O ./checkpoint/impasto --folder
```



## vt 训练

```bash
# （1） pretrain the encoder
python -m torch.distributed.launch --nproc_per_node=1 --master_port=8765 train_vtoonify_d.py --iter 30000 \
       --stylegan_path ./checkpoint/0713/generator-001500.pt \
       --exstyle_path ./checkpoint/0713/refined_exstyle_code.npy \
       --batch 1 --name vtoonify_d_0714 --pretrain

# （2）train
python -m torch.distributed.launch --nproc_per_node=1 --master_port=8765 train_vtoonify_d.py --iter 3000\
       --stylegan_path ./checkpoint/0713/generator-001500.pt \
       --exstyle_path ./checkpoint/0713/refined_exstyle_code.npy \
       --batch 2 --name vtoonify_d_0714 --fix_color --save_begin 1000 --save_every 500
```

```bash
# try some style

# fantasy
python -m torch.distributed.launch --nproc_per_node=1 --master_port=8765 train_vtoonify_d.py --iter 30000 \
       --stylegan_path ./checkpoint/fantasy/generator.pt \
       --exstyle_path ./checkpoint/fantasy/exstyle_code.npy \
       --batch 1 --name vtoonify_d_fantasy --pretrain

python -m torch.distributed.launch --nproc_per_node=1 --master_port=8765 train_vtoonify_d.py --iter 3000\
       --stylegan_path ./checkpoint/fantasy/generator.pt \
       --exstyle_path ./checkpoint/fantasy/exstyle_code.npy \
       --batch 2 --name vtoonify_d_fantasy --fix_color --save_begin 1000 --save_every 500

# anime
python -m torch.distributed.launch --nproc_per_node=1 --master_port=8765 train_vtoonify_d.py --iter 30000 \
       --stylegan_path ./checkpoint/anime/generator.pt \
       --exstyle_path ./checkpoint/anime/refined_exstyle_code.npy \
       --batch 1 --name vtoonify_d_anime --pretrain

python -m torch.distributed.launch --nproc_per_node=1 --master_port=8765 train_vtoonify_d.py --iter 3000\
       --stylegan_path ./checkpoint/anime/generator.pt \
       --exstyle_path ./checkpoint/anime/refined_exstyle_code.npy \
       --batch 2 --name vtoonify_d_anime --fix_color --save_begin 1000 --save_every 500

# impasto 
python -m torch.distributed.launch --nproc_per_node=1 --master_port=8765 train_vtoonify_d.py --iter 30000 \
       --stylegan_path ./checkpoint/impasto/generator.pt \
       --exstyle_path ./checkpoint/impasto/exstyle_code.npy \
       --batch 1 --name vtoonify_d_impasto --pretrain

# 方式1，泛用
python -m torch.distributed.launch --nproc_per_node=1 --master_port=8765 train_vtoonify_d.py --iter 3000\
       --stylegan_path ./checkpoint/impasto/generator.pt \
       --exstyle_path ./checkpoint/impasto/exstyle_code.npy \
       --batch 2 --name vtoonify_d_impasto --fix_color --save_begin 1000 --save_every 500
# 方式2，指定
python -m torch.distributed.launch --nproc_per_node=1 --master_port=8765 train_vtoonify_d.py --iter 3000\
       --stylegan_path ./checkpoint/impasto/generator.pt \
       --exstyle_path ./checkpoint/impasto/exstyle_code.npy \
       --batch 2 --name vtoonify_d_impasto --fix_color --save_begin 1000 --save_every 500 \
       --fix_degree --style_degree 0.8 --fix_style --style_id 83


# cartoon
python -m torch.distributed.launch --nproc_per_node=1 --master_port=8765 train_vtoonify_d.py --iter 30000 \
       --stylegan_path ./checkpoint/impasto/generator.pt \
       --exstyle_path ./checkpoint/impasto/exstyle_code.npy \
       --batch 1 --name vtoonify_d_impasto --pretrain

python -m torch.distributed.launch --nproc_per_node=1 --master_port=8765 train_vtoonify_d.py --iter 3000\
       --stylegan_path ./checkpoint/impasto/generator.pt \
       --exstyle_path ./checkpoint/impasto/exstyle_code.npy \
       --batch 2 --name vtoonify_d_impasto --fix_color --save_begin 1000 --save_every 500

```



## disney 训练


### DUAL

0719继续尝试，修改 batch 解决朝向问题。就是第二排

```bash
# 创建 disney 文件夹

# 生成 lmdb
python ./model/stylegan/prepare_data.py --out ./data/disney/lmdb/ --n_worker 4 --size 1024 ./data/disney/images/

# finetune stylegan
python -m torch.distributed.launch --nproc_per_node=1 --master_port=8765 finetune_stylegan.py --iter 600 --batch 4 --ckpt ./checkpoint/stylegan2-ffhq-config-f.pt --style disney --save_every 100 --augment ./data/disney/lmdb/

# 生成 style.npy
python destylize.py --model_name finetune-000600.pt --batch 2 --iter 300 disney

# 生成 generator
python -m torch.distributed.launch --nproc_per_node=1 --master_port=8765 finetune_dualstylegan.py --iter 2000 --batch 4 --ckpt ./checkpoint/generator-pretrain.pt --style_loss 0.25 --CX_loss 0.25 --perc_loss 1 --id_loss 1 --L2_reg_loss 0.015 --augment disney --save_begin 100

# 可选后续
# 默认 batch 1
python refine_exstyle.py --lr_color 0.1 --lr_structure 0.005 --ckpt ./checkpoint/disney/generator-001500.pt disney

python train_sampler.py disney
```

### 推导&中转

```bash
python style_transfer.py --model_name generator-001500.pt --style disney --style_id 64

# dualstyleGAN 部分十分正常，默认用的 refine_exstyle
python style_transfer.py --model_name generator-001500.pt --style disney --style_id 64 --weight 0.6 0.6 0.6 0.6 0.6 0.6 0.6 0.6 0.6 0.6 0.6 0 0 0 0 0 0 0


python style_map.py --model_name generator-001500.pt --style disney

python weight_map.py --model_name generator-001500.pt --style disney --style_id 11


# 生成男的
python style_map.py --model_name generator-001500.pt --style disney --content ./data/content/019706.jpg

python style_map.py --model_name generator-001500.pt --style disney --content ./data/content/006750.jpg

python weight_map.py --model_name generator-001500.pt --style disney --content ./data/content/006750.jpg --style_id 114

# 控制变量对比
python weight_map.py --model_name generator-001200.pt --style disney --content ./data/content/019706.jpg --style_id 104
python weight_map.py --model_name generator-001500.pt --style disney --content ./data/content/019706.jpg --style_id 104
python weight_map.py --model_name generator-001600.pt --style disney --content ./data/content/019706.jpg --style_id 104
python weight_map.py --model_name generator-001800.pt --style disney --content ./data/content/019706.jpg --style_id 104

```



```bash
cp -r DualStyleGAN/checkpoint/disney VToonify/checkpoint/disney

# 模型
aws s3 sync /home/ec2-user/SageMaker/DualStyleGAN/checkpoint/disney s3://dataai-warehouse-stages/machine-learning/matchmaking/hzx_models/dualstylegan_model/disney/

aws s3 sync s3://dataai-warehouse-stages/machine-learning/matchmaking/hzx_models/dualstylegan_model/disney/ /home/ec2-user/SageMaker/VToonify/DualStyleGAN/checkpoint/disney

# 数据集
aws s3 sync /home/ec2-user/SageMaker/DualStyleGAN/data/disney/images/train s3://dataai-warehouse-stages/machine-learning/matchmaking/hzx_models/dualstylegan_model/disney_dataset/

aws s3 sync s3://dataai-warehouse-stages/machine-learning/matchmaking/hzx_models/dualstylegan_model/disney_dataset/ /home/ec2-user/SageMaker/VToonify/DualStyleGAN/data/disney/images/train
```



### VT


#### 第1次


```bash


# （1） pretrain the encoder
python -m torch.distributed.launch --nproc_per_node=1 --master_port=8765 train_vtoonify_d.py --iter 30000 \
       --stylegan_path ./checkpoint/disney/generator-001500.pt \
       --exstyle_path ./checkpoint/disney/refined_exstyle_code.npy \
       --batch 1 --name vtoonify_d_disney --pretrain

# （2）train
python -m torch.distributed.launch --nproc_per_node=1 --master_port=8765 train_vtoonify_d.py --iter 3000\
       --stylegan_path ./checkpoint/disney/generator-001500.pt \
       --exstyle_path ./checkpoint/disney/refined_exstyle_code.npy \
       --batch 2 --name vtoonify_d_disney --fix_color --save_begin 1000 --save_every 500
```