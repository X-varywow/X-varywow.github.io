考纲内容：
- 文件
  - 文件的基本概念；文件元数据和索引结点(inode)
  - 文件的操作：建立，删除，打开，关闭，度，写
  - 文件的保护；文件的逻辑结构；文件的物理结构
- 目录
  - 目录的基本概念；树形目录；目录的操作；硬链接和软链接
- 文件系统
  - 文件系统的全局结构：文件系统在外存中的结构，文件系统在内存中的结构
  - 外存空闲空间管理方法；虚拟文件系统；文件系统挂载


## 4.1 文件

文件，是存储在计算机上的信息集合

### 4.1.1 文件的基本概念

- **文件元数据**，又称 文件属性
  - 名称
  - 类型
  - 创建者、所有者等
- **文件控制块（FCB）**
  - 用来存放控制文件需要的各种信息的数据结构
  - FCB 的有序集合称为**文件目录**，一个 FCB 就是一个文件目录项
- **索引结点**
  - 是对 FCB 的一种改进，采用了文件名、文件描述信息分开的方法
  - 使文件描述信息单独形成一个称为 索引结点 的数据结构，简称 i结点
  - 文件目录中，每个目录项仅由文件名和指向索引结点的指针构成

### 4.1.2 文件的操作

基本都带有系统系统调用：create, delete, open, read, write ...

- 创建文件
  - 分配外存空间，创建目录项
- 写文件
  - 搜索目录以找到相关目录项，维护一个写指针
- 读文件
  - 搜索目录以找到相关目录项，维护一个读指针
- 重新定位文件
- 删除文件
  - 检索目录项，释放存储空间，删除目录条目
- 截断文件

一旦完成 FCB 在磁盘上的定位，系统将不再使用文件名，而是 文件描述符(unix)、文件句柄(Windows)

### 4.1.3 文件的保护

  - 口令保护
  - 加密保护
  - 访问控制（常由用户访问权限和文件属性共同控制）

## 4.2 文件的结构

逻辑结构：从用户层面，看到的文件组织方式

物理结构：从实现层面，外存上存储组织的方式

### 4.2.1 文件的逻辑结构

- 无结构文件
  - 【文件内部的数据就是一系列二进制流或字符流，如`txt`文件】
- 有结构文件
  - 顺序文件
  - 索引文件
  - 索引顺序文件

### 4.2.2 文件的物理结构

- **连续分配**（不利于扩展，存在外部碎片）
  - 【每个文件在磁盘上占有一组连续的块】
- **链接分配**（不支持随机访问）
  - 隐式链接
    - 磁盘块含有指针，对用户透明
    - 目录项中含有文件第一块、最后一块的指针（不支持随机访问，查找效率低）
  - 显式链接
    - 【把用于链接文件各物理块的指针显式地存放在一张表中，即`FAT`(file allocation table)】
    - 【一个磁盘仅设置一张 `FAT`，开机时将 `FAT` 读入内存，并常驻内存。】
- **索引分配**（容易扩展、支持随机访问）
  - 【系统为每个文件建立一张索引表，索引表记录了文件地各个逻辑块对应的物理块】
  - 优点：
    - 支持直接访问，无外部碎片
  - 缺点：
    - 存储空间开销
  - 如何支持大文件？
    - 链接方案
    - 多层索引
    - 混合索引
- **混合索引分配**
  - 直接地址
  - 一次间接地址
  - 多次间接地址

----------------

在采用混合索引分配方式时，假如有 N0 个直接地址，N1 个一次间接地址，N2 个二次间接地址；每个盘块大小 M 字节，盘块号占 m 字节：其允许的文件最大长度：$$(N0 + N1\times \frac{M}{m} + N2\times (\frac{M}{m})^2)\times M$$



## 4.3 目录

`目录` 本身就是一个有结构文件，由一条条记录组成；每条记录对应一个在该目录下的文件。

"/home/fin" 绝对路径，"./fin" 相对路径

FCB 的有序集合称为文件目录，一个 FCB 就是一个个文件目录项

利用树形目录结构解决不同用户文件重名问题

-----------------

文件共享

- 基于索引结点的共享方式（`硬链接`）
  - 【各个用户的目录项指向同一个索引结点】
  - 优点：实现了异名共享
  - 缺点：文件拥有者不能删除与他人共享的文件
- 基于符号链的共享方式（`软链接`）
  - 【相当于创建索引结点的快捷方式】
  - 优点：拥有者可删除共享文件
  - 缺点：访问时，根据路径名各个分量逐个查找，访问开销大

## 4.4 文件系统

文件管理系统：操作系统中负责管理和存储文件信息的软件机构

### 4.4.1 文件系统结构

- /应用程序/
- 逻辑文件系统
  - 用于管理元数据信息
- 文件组织模块
  - 组织文件及其逻辑块和物理块
- 基本文件系统
  - 向驱动发送通用指令，等
- IO控制
  - 设备驱动程序，中断处理程序等
- /设备/

### 4.4.2 文件存储空间管理

- 存储空间的划分和初始化
  - `划分`【将物理磁盘划分为一个个文件卷（逻辑卷，逻辑盘）】
  - `初始化`【将各个文件卷划分为目录区、文件区】
- 管理方法：
  - 空闲表法
  - 空闲链表法
  - 位示图法
  - 成组链接法

## 4.5 虚拟文件系统

- 超级块对象（表示一个已安装（挂载）的特定文件系统）
- 索引结点对象（表示一个特定的文件）
- 目录项对象（表示一个特定的目录项）
- 文件对象（表示一个与进程相关的打开文件）