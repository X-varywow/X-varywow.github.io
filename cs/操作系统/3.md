考纲内容：
- 内存管理基础
  - 内存管理概念：逻辑地址与物理地址空间，地址变换，内存共享，内存保护，内存分配与回收
  - 连续分配管理方式；页式管理；段式管理；段页式管理
- 虚拟内存管理
  - 虚拟内存基本概念；请求页式管理；页框分配；页置换算法
  - 内存映射文件；虚拟存储器性能的影响因素及改进方式

## 3.1 程序运行基本原理

`从写程序到程序运行`：
- 编辑源代码文件
- 编译
  - 【由源代码生成目标模块，高级语言->机器语言】
- 链接
  - 【由目标模块生成装入模块，链接后形成完整的逻辑地址】
- 装入
  - 【将装入模块装入内存，装入后形成物理地址】

------------

- 逻辑地址：相对地址；
- 物理地址：绝对地址

## 3.2 内存管理主要功能

- 内存空间的**分配与回收**
- 内存空间的**扩充**（实现虚拟性）
  - 覆盖技术
    - 【将程序分为多个段，常用的段常驻内存，不常用的段在需要时调入内存】
    - 缺点：对用户不透明，增加了用户编程负担。
  - 交换技术
    - 【进程在内存与磁盘之间动态调度，但PCB会常驻内存】
  - 虚拟内存（参考 3.4）
- **地址转换**
  - 【操作系统负责实现逻辑地址到物理地址的转换】
  - 三种方式：
    - 绝对装入【编译器负责地址转换】（单道程序阶段）
    - 可重定位装入【装入程序负责地址转换】（早期多道批处理系统）
    - 动态运行时装入【运行时进行地址转换】（现代操作系统）
- **存储保护**
  - 【保证各进程在自己的内存空间内运行】
  - 两种方式：
    - 设置上下限寄存器
    - 利用重定位寄存器、界地址寄存器进行判断


## 3.3 内存空间的分配与回收

- 连续分配管理方式
  - 单一连续分配
    - 分为系统区，用户区，用户区仅有一道程序
    - 特点：简单、无外部碎片，存储器利用率极低
  - 固定分区分配
    - 分区大小可不等、可相等
    - 无外部碎片，存储空间利用率低
  - 动态分区分配
    - 首次适应算法（按地址顺序，分配第一个符合要求的空闲内存给作业）
    - 临近适应算法（地址从上次查找结束的位置开始）
    - 最佳适应算法（按大小递增顺序，分配第一个符合要求的空闲内存给作业）
      - 会产生最多的外部碎片
    - 最坏适应算法（按大小递减顺序，分配第一个符合要求的空闲内存给作业）
- 非连续分配管理方式⭐
  - 基本分页存储管理
  - 基本分段存储管理
  - 段页式存储管理

---------------------

`分页 Vs 分段`


|          | 分页存储管理               | 分段存储管理                                         |
| -------- | -------------------------- | ---------------------------------------------------- |
| 优点     | 能有效地**提高内存利用率** | 能反映程序的逻辑结构，从而**有利于程序的共享和保护** |
| 碎片     | 有内部碎片，无外部碎片     | 无内部碎片，有外部碎片                               |
| 地址空间 | 一维，单一的线性地址空间   | 二维，段名+段内地址                                  |
|          | 页面大小一致               | 段长大小不等                                         |


---------------

快表机制的计算，

二级页表的计算

## 3.4 虚拟内存管理 ⭐

虚拟内存，程序不需装入即可运行，运行时根据需要动态调入数据，若内存不够，还需换出一些数据.


基于程序的局部性原理
- 时间局部性，程序的某条指令一旦执行，不久后该指令可能再次执行
- 空间局部性，一旦程序访问了某个存储单元，不久后相邻的存储单元也将被访问

主要特征：
  - `多次性`：允许作业多次调入内存
  - `对换性`：允许作业运行过程中，将作业换入、换出
  - `虚拟性`：从逻辑上扩充了内存的容量


- 实现方式：
  - 请求分页存储管理
  - 请求分段存储管理
  - 请求段页式存储管理

### 3.4.1 请求分页管理

- 页表机制
  - 页表项：/页号/物理块号/状态位/访问字段/修改位/外存地址/
- 缺页中断机构
- 地址变换机构

### 3.4.2 内存分配

不存在固定分配全局置换，全局置换（从全局队列中取出一块）意味着一个进程拥有的物理块数可以改变，因此不可能是固定分配。

### 3.4.3 页面置换算法

| 算法          | 描述                                                        | 特性                               |
| ------------- | ----------------------------------------------------------- | ---------------------------------- |
| 最佳置换算法  | 优先淘汰不会被访问的页面                                    | 缺页率最小，无法实现               |
| 先进先出算法  | 优先淘汰最先进入内存的页面                                  | 实现简单、性能差，Belady异常       |
| LRU算法       | 优先淘汰最近最久未使用的页面                                | 性能很好，需要硬件支持，算法开销大 |
| CLOCK算法     | 循环扫描各页面，第一轮淘汰访问位=0的页面，并置0；第二轮继续 | 算法开销小                         |
| 改进CLOCK算法 | 1.找(0,0)；2.找(0,1),置0；3.找(0,0)；4.找(0,1)              | 算法开销小，性能不错               |

### 3.4.4 抖动与工作集

- 抖动：频繁的页面调度行为
  - 发生原因：系统运行的进程过多，分配的物理块太少不满足要求
- 工作集：最近访问过的页面

---------

eg. 微服务(容器名)整体内存使用率, 监控系统中就有对内存使用的划分

WSS(工作集大小, working set size), 指程序在某一时间点实际驻留在物理内存的数据集大小（当前活跃并使用的内存集合）

RSS(常驻集大小, resident set size), 指一个进程中当前驻留在物理内存中的部分的大小，包括所有共享的和专用的、已经加载到RAM中的页面。不过RSS可能不包含某些可延迟加载的部分，如懒加载的库等。

在大多数情况下，RSS 应该是等于或大于 WSS 的，因为它包括了所有驻留在物理内存中的页面，无论它们是否当前被活跃使用。



