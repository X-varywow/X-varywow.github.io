考纲内容：
- 网络层的功能
  - 异构网络互联；路由与转发；SDN基本概念；拥塞控制
- 路由算法
  - 静态路由与动态路由；距离-向量路由算法；链路状态路由算法；层次路由
- IPv4
  - IPv4分组；IPv4地址与NAT；子网划分与子网掩码、CIDR、路由聚合、ARP、DHCP与ICMP
- IPv6
  - IPv6的主要特点；IPv6地址
- 路由协议
  - 自治系统；域内路由与域间路由；RIP路由协议；OSPF路由协议；BGP路由协议
- IP组播
  - 组播的概念；IP组播地址
- 移动IP
  - 移动IP的概念；移动IP的通信过程
- 网络层设备
  - 路由器的组成与功能；路由表与路由转发

## 4.1 概述

网络层提供主机之间的逻辑通信

- **主要任务**：把分组从源端传到目的端，为分组交换网上的不同主机提供通信服务。
- 协议：`IP`, `ARP`地址解析协议, `ICMP` 因特网控制报文协议, `IGMP` 因特网组管理协议
- 传输单位：数据报
- **功能**：
  - 路由选择与分组转发
  - 异构网络互联
  - 拥塞控制
    - 开环控制（预先考虑好，静态控制）
    - 闭环控制（动态地控制）

网络层向上**提供简单灵活的、无连接的、尽最大努力交付的数据报服务**。

----------------------

## 4.2 网络互连

**互联网络**：利用网桥、路由器等互联设备将两个及两个以上的物理网络相互连接起来构成的系统。
局域网、广域网是互联网的构件，在局域网或广域网内部主机通信使用网络的物理地址。

- 直接交付
  - 是指在一个物理网络上，数据报从一台机器上直接传送到另一台机器上，这是所有互联网通信的基础。
  - 只有当两台机器同时连到同一底层物理传输系统时（例如一个以太网），才能进行直接交付
- 间接交付
  - 当目的地不在一个直接连接的网络上时，发送方必须把数据报发给一个路由器才能交付它


通常将网络层使用的路由器称为 `网关`。

-------------------

一些概念：<br>
报文 `message`：要发送的整块数据。<br>
首部 `header`：必要的控制信息。<br>
分组 `packet`：由报文+首部组成，也叫包。


---------------------

## 4.3 路由与转发

**路由** `routing` 是指分组从源到目的地时，决定端到端路径的网络范围的进程。
路由工作在网络层的数据包转发设备。路由器通过转发数据包来实现网络互连。

- `功能一`：运行路由选择算法、协议
  - 路由算法
    - 静态路由算法
    - 动态路由算法（路由器间彼此交换信息，按照算法优化出路由表项）
      - 距离-向量路由算法
      - 链路状态路由算法
  - 路由选择协议
    - 内部网关协议IGP（RIP,OSPF）
    - 外部网关协议EGP（BGP）
- `功能二`：从入链路到出链路 转发 数据报

路由器可以进行路由选择和分组转发。
路由器对目的地址是私有IP地址的数据报一律不进行转发

**默认路由**：当路由表中与包的目的地址之间没有匹配的表项时路由能做出的选择。

**默认网关**：一台主机如果找不到可用的网关，就把数据包发给默认指定的网关，默认网关最后一位为1。

本质上应该差不多，只是不同场景下马甲

## 4.4 路由协议

- 内部网关协议IGP
  - `RIP`
    - 16：表示不可达
    - 优点：实现简单、开销小、收敛过程快
    - 缺点：限制网络规模，坏消息传得慢
  - `OSPF`
- 外部网关协议EGP
  - `BGP`


|          | RIP                  | OSPF                 | BGP                                    |
| -------- | -------------------- | -------------------- | -------------------------------------- |
| 类型     | 内部                 | 内部                 | 外部                                   |
| 路由算法 | 距离-向量            | 链路状态             | 路径-向量                              |
| 传递协议 | UDP                  | IP                   | TCP                                    |
| 路径选择 | 跳数最小             | 代价最低             | 较好，非最佳                           |
| 交换结点 | 和本结点相邻的路由器 | 网络中所有路由器     | 和本结点相邻的路由器                   |
| 交换内容 | 自己的路由表         | 相邻路由器的链路状态 | 首次：整个路由表；非首次：有变化的部分 |

## 4.5 ARP协议

ARP（Address Resolution Protocol）即 **地址解析协议**， 用于实现从 IP 地址到 MAC 地址的映射，即询问目标IP对应的MAC地址。

>属于网络层，靠近数据链路层

- ARP协议自动进行
- **ARP表**
  - 格式：<IP地址；MAC地址；TTL>
  - 其中TTL为地址长度将被忘记的时间长度（通常20分钟）


## 4.6 IP地址⭐
IP地址 Internet Protocol Address，是指互联网协议地址，又译为网际协议地址。

##### （1）IP协议特点

- **不可靠、无连接、尽力而为**的数据报服务
- 发送 IP 数据报后不维护任何状态信息
- 不能保证IP数据报成功到达目的地
- 独立处理对待每个数据报，发生错误的处理方法是丢弃并利用 ICMP 报告
- 对传输正确性不做验证，不发确认。
- 点对点网络层协议，分为直接交付和间接交付
- 向传输层屏蔽物理网络的差异

##### （2）IP地址分类

| IP地址类别 | 地址范围                      | 地址构成                       | 说明                     |
| ---------- | ----------------------------- | ------------------------------ | ------------------------ |
| A类        | `1.0.0.0 ~ 127.255.255.255`   | `0`+`7`位网络号+`24`位主机号   | 适用于大型网络           |
| B类        | `128.0.0.0 ~ 191.255.255.255` | `10`+`14`位网络号+`16`位主机号 | 使用中等大小组织         |
| C类        | `192.0.0.0 ~ 223.255.255.255` | `110`+`21`位网络号+`8`位主机号 | 适用于一些小型公司等     |
| D类        | `224.0.0.0 ~ 239.255.255.255` | `1110`+`28`位组播地址          | 用于特殊用途，如多播地址 |
| E类        | `240.0.0.0 ~ 255.255.255.255` | `11110...`                     | 暂时保留                 |

<br>

##### （3）特殊IP地址

- 回送地址用于网络软件测试和本地进程间通信。网络号为`127` 的分组不能出现在任何网络上
- 本地回环地址，`127.0.0.1`
- **网络地址**，`192.168.12.0`
  - 主机号全0
- **广播地址**，`192.128.12.255`
  - 主机号全1
- 受限广播，`255.255.255.255`
- 本网内本主机，`0.0.0.0`

##### （4）私有IP地址
，只能在局域网内使用

| 私有IP地址类别 | 地址范围                        | 网段个数 |
| -------------- | ------------------------------- | -------- |
| A类            | `10.0.0.0 ~ 10.255.255.255`     | 1        |
| B类            | `172.16.0.0 ~ 172.31.255.255`   | 16       |
| C类            | `192.168.0.0 ~ 192.168.255.255` | 256      |

<br>

========== 其它补充

在同一个局域网上的主机或路由器的IP地址中的网络号必须是一样的。

私网IP要接入Internet时，要使用 `NAT` **网络地址转换**
安装了NAT软件（含NAT转换表）的路由器叫NAT路由器，它至少有一个有效的外部全球IP地址。

### IP数据报⭐

<img src="https://img-1301102143.cos.ap-beijing.myqcloud.com/202112041111080.jpg">

- 版本 : 有 4（IPv4）和 6（IPv6）两个值；
- 首部长度 : 占 4 位，因此最大值为 15。值为 1 表示的是 1 个 32 位字的长度，也就是 4 字节。因为固定部分长度为 20 字节，因此该值最小为 5。如果可选字段的长度不是 4 字节的整数倍，就用尾部的填充部分来填充。
- 区分服务 : 用来获得更好的服务，一般情况下不使用。
- 总长度 : 包括首部长度和数据部分长度。
- 生存时间 ：TTL，它的存在是为了防止无法交付的数据报在互联网中不断兜圈子。以路由器跳数为单位，当 TTL 为 0 时就丢弃数据报。
- 协议 ：指出携带的数据应该上交给哪个协议进行处理，例如 ICMP、TCP、UDP 等。
- 首部检验和 ：因为数据报每经过一个路由器，都要重新计算检验和，因此检验和不包含数据部分可以减少计算的工作量。
- 标识 : 在数据报长度过长从而发生分片的情况下，相同数据报的不同分片具有相同的标识符。
- 片偏移 : 和标识符一起，用于发生分片的情况。片偏移的单位为 8 字节。


>IP数据报，数据报，分组，包都是同一个东西

?>什么是IP分片？
<br>IP协议在传输数据包时会将数据报文分成若干片进行传输，每个分片独立地传输到目的地，其间可能会经过不同路径，而最后在目的主机中进行重组。这一过程就成为分片。

?>为什么要进行IP分片
<br>如果IP数据报加上数据帧头部后大于MTU，数据报文就会分成若干片进行传输。那么什么是MTU呢？每一种物理网络都会规定链路层数据帧的最大长度，称为链路层MTU。在以太网的环境中可传输的最大IP报文为1500字节。<br>如果要传输的数据帧的大小超过1500字节，即IP数据报的长度大于1472（1500-20-8=1472，普通数据报）字节，需要分片之后进行传输。

?>关于标志位
<br>MF：表示后面是否“还有分片”。MF = 0 表示这是若干数据报分片的最后一个<br>DF（Don't fragment）：标志着允不允许数据报分片

## 4.7 子网划分与地址聚合⭐
- 子网
  - 具有IP地址相同的子网部分的设备接口
  - 能够物理上互相到达而没有中间路由器
- **子网掩码**：用来指明一个IP地址的哪些位标识的是主机所在的子网，以及哪些位标识的是主机的位掩码。
  - 作用：将某个 IP 地址划分成网络地址和主机地址两部分
- 默认掩码：
  - `A类`：255.0.0.0
  - `B类`：255.255.0.0
  - `C类`：255.255.255.0

[子网划分习题参考](https://blog.csdn.net/dyyay521/article/details/94381876)

变长子网划分，

**地址聚合**：即求二进制地址的最长公共前缀，并把/x改成位数

## 4.8 ICMP

网际控制报文协议 Internet Control Message Protocol

ICMP 是为了**更有效地转发 IP 数据报和提高交付成功的机会**。它封装在 IP 数据报中，但是不属于高层协议。

- ICMP 报文的种类有两种
  - `ICMP 差错报告报文`
    - 终点不可达
    - 源点抑制
      - 路由器或主机由于拥塞而丢弃数据报时
    - 时间超过
    - 参数问题
      - 数据报首部字段的值不正确
    - 改变路由
  - `ICMP 询问报文`
- 不应发送差错报告报文的情况：
  - 对差错报告报文不发送差错报告
  - 对第一个分片的后续分片不发送
  - 对具有组播地址的数据报不发送
  - 对具有特殊地址（127.0.0.0，0.0.0.0等）的数据报不发送

---------------------------

`Ping` 的原理是通过向目的主机发送 ICMP Echo 请求报文，目的主机收到之后会发送 Echo 回答报文。

Ping 会根据时间和成功响应的次数估算出数据包往返时间以及丢包率。

**PING 指令的流程**：先进行DNS解析，之后用网络层协议ARP，通过目标主机的IP地址映射为MAC地址，通过IP地址可以知道数据包最后发给谁，MAC地址可以知道数据包下一跳给谁。之后用网络层协议ICMP来传递主机间的控制信息。由于主机间没有连接过程，是直接发送数据的，所以未使用传输层的 TCP 和 UDP。

## 4.9 IP 组播

使用 **部分** D 类地址 `224.0.0.0 ~ 239.255.255.255` 进行组播（多播）

主机组播时仅发送一份数据，需要组播路由器的支持（复制并转发）

IGMP 因特网组管理协议，使路由器知道组成员的信息。

## 4.10 移动IP

移动IP技术：移动结点以固定的网络IP地址实现跨越不同网段的漫游功能

- **移动结点**，具有永久IP地址
  - 在使用移动IP进行通信时，归属代理和外部代理之间需要建立一条隧道
- **本地代理**，又叫归属代理
- **外部代理**，当移动到外部网络中，帮助结点完成移动管理

## 4.11 IPv6

- 主要特点：
  - 地址空间：32bit -> 128bit
  - 移除了校验和字段，提高路由的选择效率
    - 因为其他层的功能足以代替IP中的校验和

- 目的地址：
  - 单播，传统的点对点通信
  - 多播，
  - 任播

- IPv6地址的缩写：
  - 域中必须至少有一个数字
  - :: 只能出现一次

- IPv4向IPv6过渡：
  - 双协议栈技术
  - 隧道技术
    - 将IPv6数据报封装到IPv4数据报的数据部分


## 4.12 题型分析

概念题、

子网划分、子网聚合、路由协议计算

网络互联综合题，P165 T48