考纲内容：
- 传输层提供的服务
  - 传输层的功能；传输层寻址与端口；无连接服务和面向连接服务
- UDP
  - UDP数据报；UDP校验
- TCP
  - TCP段；TCP连接管理；TCP可靠传输；TCP流量控制与拥塞控制

## 5.1 概述

只有主机才有的层次。

- **主要作用**
  - 提供进程和进程之间的逻辑通信
  - 复用和分用
  - 对收到的报文进行差错检测
- **两个协议**
  - `TCP`（面向连接的传输控制协议）⭐
      - 连接管理（三次握手，四次握手）
      - 可靠传输
      - 流量控制（滑动窗口）
      - 拥塞控制
  - `UDP`（无连接的用户数据报协议）
    - 无连接
    - 尽最大努力交付
    - 面向报文
    - 没有拥塞控制
    - 支持一对一、一对多、多对一、多对多的交互通信
    - 首部开销少，只有 8 个字节，TCP首部 20 个字节

------------------------


## 5.2 TCP协议⭐

- 主要特点
  - **面向连接** 的运输层协议，需要事先建立连接
  - 提供 **可靠交付** 的服务，无差错、不丢失，不重复，并且按序到达
  - 提供 **全双工通信**，TCP连接的两端都设有发送缓存和接收缓存
  - **面向字节流**，即将应用程序交下来的数据看成一串无结构的字节流

### 5.2.1 TCP报文结构

<img src="https://img-blog.csdnimg.cn/20210608152713753.png" style="zoom:60%">

- 源端口号和目的端口号：再加上Ip首部的源IP地址和目的IP地址可以唯一确定一个TCP连接
- 数据序号：表示在这个报文段中的第一个数据字节序号
- 确认序号：仅当ACK标志为1时有效。确认号表示期望收到的下一个字节的序号
- 偏移：就是头部长度，有4位，跟IP头部一样，以4字节为单位。最大是60个字节
- 保留位：6位，必须为0
- 6个标志位：
  - URG-紧急指针有效
  - ACK-确认序号有效
  - PSH-接收方应尽快将这个报文交给应用层
  - RST-连接重置
  - SYN-同步序号用来发起一个连接
  - FIN-终止一个连接
- 窗口字段：16位，代表的是窗口的字节容量，也就是TCP的标准窗口最大为2^16 - 1 = 65535个字节（这个下面再详细分析）
- 校验和：源机器基于数据内容计算一个数值，收信息机要与源机器数值 结果完全一样，从而证明数据的有效性。检验和覆盖了整个的TCP报文段：这是一个强制性的字段，一定是由发送端计算和存储，并由接收端进行验证的。
- 紧急指针：是一个正偏移量，与序号字段中的值相加表示紧急数据最后一个字节的序号。TCP的紧急方式是发送端向另一端发送紧急数据的一种方式


### TCP的连接
TCP 把连接作为最基本的抽象

`套接字` Socket =（主机IP地址，端口号）

在计算机网络中采用发送方和接收方的套接字组合来识别端口，
套接字唯一标识了网络中的一个主机和它上面的一个进程。

### TCP传输连接建立

<img src="https://img-1301102143.cos.ap-beijing.myqcloud.com/202112041111071.png" style="zoom:60%">

### TCP传输连接释放

<img src="https://img-1301102143.cos.ap-beijing.myqcloud.com/202112041111377.png" style="zoom:60%">

### 关于TCP协议的问答

?> 建立一个TCP连接需要的信息共识?
- Socket：由IP地址和端口号组成
- 序列号：用来解决乱序问题
- 窗口大小：用来做流量控制


?> 如何确定一个TCP连接?

TCP四元组（源地址，源端口，目标地址，目标端口）

?> TCP 和 UDP 的区别?
- `连接`
  - TCP是面向连接，传输数据前需建立连接
  - UDP无连接，即刻传输数据
- `服务对象`
  - TCP是一对一的两点服务
  - UDP支持一对一、一对多、多对多的交互通信
- `可靠性`
  - TCP可靠交互数据
  - UDP不保证可靠交互数据
- `TCP拥有拥塞控制和流量控制机制`
- `传输方式`
  - TCP是流式传输，没有边界，但保证顺序和可靠
  - UDP是一个一个包的发送，是有边界的，但可能会丢包和乱序
- `应用场景`
  - TCP应用场景
    - FTP文件传输
    - HTTP/HTTPS
  - UDP应用场景
    - 包总量较少的通信，如DNS、SNMP等
    - 视频，音频等多媒体通信
    - 广播通信


----------------------

## 5.3 端口

**端口**是传输层的SAP（服务接入点），标识主机中的应用进程

端口号只有本地意义，长度为`16bit`，能表示65536个不同的端口。

- 端口号
  - **服务端**使用的端口号
    - 熟知端口号 `0~1024`
    - 登记端口号 `1024~49151`
  - 客户端使用的端口号
    - `49152~65535`：仅在客户进程运行时才动态选择。

| 应用程序   | FTP数据连接 | FTP控制连接 | TELNET | SMTP | DNS | TFTP | HTTP | POP3 | SNMP |
| ---------- | ----------- | ----------- | ------ | ---- | --- | ---- | ---- | ---- | ---- |
| 使用协议   | TCP         | TCP         | TCP    | TCP  | UDP | UDP  | TCP  | TCP  | UDP  |
| 熟知端口号 | 20          | 21          | 23     | 25   | 53  | 69   | 80   | 110  | 161  |

## 5.4 拥塞控制

<img src = "https://img-blog.csdnimg.cn/20210705112852630.jpg">

记轮次为$n$，拥塞窗口为$cwnd$，慢开始门限为$ssthresh$
- 慢开始
  - 拥塞窗口逐轮翻倍，在此阶段不能大于$ssthresh$
- 拥塞避免
  - $cwnd \ge ssthresh$ 时进入拥塞避免，$cwnd$逐轮加一
  - 超时时重新开始，$ssthresh=cwnd/2$
- 快重传和快恢复
  - $3−ACK$，表示收到3个重复确认报文，数据传输时丢失了，进入快重传和快恢复
  - $cwnd=ssthresh=原cwnd/2$

## 5.5 题型分析

- 基础概念题
- 拥塞控制
- 报文段传输中的序号问题 P238 T17 T31
- 发送窗口值 P237 T06 T19 T28 T33